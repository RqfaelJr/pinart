{% extends "base_cadastro.html" %}
{% block title %}Cadastro de Endereço — PinArt{% endblock %}
{% block header %}Cadastro — Endereço{% endblock %}

{% block content %}
  <p class="small">Preencha o endereço abaixo. Após salvar, você retornará automaticamente ao cadastro anterior.</p>

  <form method="post" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="errors">
        {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    <div class="form-row">
      <label for="id_cep">CEP</label>
      {{ form.cep }}
      {% if form.cep.errors %}
        <div class="field-error">{{ form.cep.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_rua">Rua</label>
      {{ form.rua }}
      {% if form.rua.errors %}
        <div class="field-error">{{ form.rua.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_numero">Número</label>
      {{ form.numero }}
      {% if form.numero.errors %}
        <div class="field-error">{{ form.numero.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_complemento">Complemento</label>
      {{ form.complemento }}
      {% if form.complemento.errors %}
        <div class="field-error">{{ form.complemento.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_bairro">Bairro</label>
      {{ form.bairro }}
      {% if form.bairro.errors %}
        <div class="field-error">{{ form.bairro.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_cidade">Cidade</label>
      {{ form.cidade }}
      {% if form.cidade.errors %}
        <div class="field-error">{{ form.cidade.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_estado">Estado</label>
      {{ form.estado }}
      {% if form.estado.errors %}
        <div class="field-error">{{ form.estado.errors|striptags }}</div>
      {% endif %}
    </div>

    <input type="hidden" name="next" value="{{ request.GET.next }}">

    <p style="margin-top:14px">
      <button class="btn" type="submit">Salvar endereço</button>
      <a class="btn secondary" href="{{ request.GET.next }}">Voltar sem salvar</a>
    </p>
  </form>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
      const cepInput = document.querySelector("#id_cep");

      cepInput.addEventListener("blur", function () {
          let cep = cepInput.value.replace(/\D/g, "");

          if (cep.length !== 8) {
              return;
          }

          fetch(`https://viacep.com.br/ws/${cep}/json/`)
              .then(response => response.json())
              .then(data => {
                  if (!data.erro) {
                      document.querySelector("#id_rua").value = data.logradouro;
                      document.querySelector("#id_bairro").value = data.bairro;
                      document.querySelector("#id_cidade").value = data.localidade;
                      document.querySelector("#id_estado").value = data.uf;
                  } else {
                      alert("CEP não encontrado!");
                  }
              })
              .catch(() => {
                  alert("Erro ao consultar o CEP.");
              });
      });
  });
  </script>

{% endblock %}
